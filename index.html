<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç‹å¯æ¨‚æ—¥èªï½œ JLPT å¼±é»åˆ†ææ›¸é ˜å–</title>
  <style>
    :root{
      --bg:#f0f4ff;
      --card:#fff;
      --text:#111;
      --muted:#667085;
      --border:#e6e6e6;
      --primary:#4f46e5;
      --primaryText:#fff;
      --danger:#ef4444;
      --success:#10b981;
      --shadow: 0 12px 30px rgba(79,70,229,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:640px;margin:0 auto;padding:22px 14px 56px}

    .topbar{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 18px;
      padding: 20px 18px;
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .titleBlock h1{font-size:18px;line-height:1.35;margin:0;color:#fff}
    .titleBlock .sub{color:rgba(255,255,255,.9);font-size:13px;line-height:1.6;margin:4px 0 0}


    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px 16px;
      margin-top:14px;
      box-shadow: var(--shadow);
    }

    .pageTitle{font-size:18px;margin:0 0 6px;line-height:1.35}
    .pageDesc{color:var(--muted);font-size:14px;line-height:1.65;margin:0 0 12px}

    label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid #cfd4dc;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,.15)}
    input:disabled{background:#f5f6f7;color:#555}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      flex:1;
      min-width: 160px;
      padding:13px 14px;
      border-radius:14px;
      border:0;
      font-size:16px;
      cursor:pointer;
    }
    .primary{background:var(--primary);color:var(--primaryText)}
    .secondary{background:#f2f4f7;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}

    .msg{margin-top:12px;font-size:14px;line-height:1.65;white-space:pre-wrap}
    .ok{color:var(--success)}
    .bad{color:var(--danger)}

    .levels{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
    .lv,.rd{
      border:1px solid #cfd4dc;
      border-radius:14px;
      padding:12px 10px;
      text-align:center;
      cursor:pointer;
      font-weight:800;
      background:#fff;
      user-select:none;
    }
    .lv small,.rd small{display:block;font-weight:600;color:var(--muted);margin-top:4px}
    .lv.active,.rd.active{border-color:var(--primary);background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff; box-shadow: 0 4px 12px rgba(79,70,229,.25)}
    .lv.active small,.rd.active small{color:rgba(255,255,255,.9)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:#f2f4f7;border:1px solid #e4e7ec;
      color:#344054;font-size:13px;margin:6px 0 0;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;
    }

    .hint{
      font-size:14px;color:#344054;line-height:1.7;
      background:#f5f4ff;border:1px dashed #c4b5fd;border-radius:14px;
      padding:10px 12px;margin-top:12px;font-weight:500;
    }

    .errorTitle{
      font-size:18px;
      line-height:1.6;
      color:var(--danger);
      margin-bottom:8px;
    }

    .hidden{display:none}

    @media(min-width:640px){
      .wrap{padding:26px 14px 64px}
      .titleBlock h1{font-size:20px}
      .levels{grid-template-columns:repeat(5,1fr)}
      button{flex:0 0 auto}
    }

    a{color:#111}
  </style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="titleBlock">
        <h1>ç‹å¯æ¨‚æ—¥èªï½œ JLPT å¼±é»åˆ†ææ›¸é ˜å–</h1>
      </div>
    </div>
  </div>

  <section id="page1" class="card">
    <h2 class="pageTitle">é¸æ“‡è€ƒè©¦å›æ•¸èˆ‡ç­‰ç´šä¸¦å¡«å¯«ç•¶åˆç™»è¨˜å¼±é»åˆ†ææ›¸çš„ Email</h2>
    <p class="pageDesc">
      1. å…ˆé¸æ“‡ä½ ç•¶åˆå ±åçš„ã€Œè€ƒè©¦å›æ•¸ã€èˆ‡ã€Œç­‰ç´šã€ã€‚<br>
      2. å†è¼¸å…¥ç•¶åˆç™»è¨˜é ˜å–å¼±é»åˆ†ææ›¸çš„ Emailï¼Œæˆ‘å€‘æœƒå¯„å‡ºé©—è­‰ç¢¼çµ¦ä½ ã€‚<br>
      3. æ”¶åˆ°é©—è­‰ç¢¼å¾Œï¼Œä¸‹ä¸€æ­¥è¼¸å…¥é©—è­‰ç¢¼å³å¯æŸ¥è©¢ä¸‹è¼‰é€£çµã€‚
    </p>

    <label>é¸æ“‡è€ƒè©¦å›æ•¸ï¼ˆä¸€å®šè¦è·Ÿç•¶åˆå ±åçš„å›æ•¸ä¸€æ¨£ï¼‰</label>
    <div class="levels" id="rounds"></div>

    <p class="hint">
      <strong>æ›´æ—©ä»¥å‰çš„è€ƒè©¦</strong>è‹¥è¦æŸ¥è©¢å¼±é»åˆ†ææ›¸ï¼Œè«‹ç§è¨Šå®˜æ–¹ LINE ç”±åŠ©æ•™å”åŠ©ã€‚<br>
      <a href="https://page.line.me/ctq6019m?oat_content=url&openQrModal=true" target="_blank" rel="noopener noreferrer">ğŸ‘‰ é»é€™è£¡é–‹å•Ÿå®˜æ–¹ LINE</a>
    </p>

    <label>é¸æ“‡ç­‰ç´šï¼ˆä¸€æ¬¡é ˜ä¸€å€‹ï¼Œéœ€èˆ‡ç•¶åˆå ±åç­‰ç´šä¸€è‡´ï¼‰</label>
    <div class="levels" id="levels"></div>

    <label>ç•¶åˆç™»è¨˜å¼±é»åˆ†ææ›¸çš„ Email</label>
    <input id="email" placeholder="ä¾‹å¦‚ï¼šuser@example.com" autocomplete="email" />

    <div class="btnRow">
      <button id="btnSend" class="primary">å¯„é€é©—è­‰ç¢¼</button>
    </div>

    <div id="msg1" class="msg"></div>
  </section>

  <section id="page2" class="card hidden">
    <h2 class="pageTitle">è¼¸å…¥ Email ä¸­æ”¶åˆ°çš„ 6 å€‹æ•¸å­—é©—è­‰ç¢¼</h2>
    <p class="pageDesc">
      è«‹æ‰“é–‹å‰›å‰›å¡«å¯«çš„ Email ä¿¡ç®±ï¼Œæ‰¾åˆ°ç³»çµ±å¯„å‡ºçš„é©—è­‰ä¿¡ï¼Œ<br>
      æŠŠä¿¡ä¸­é¡¯ç¤ºçš„ 6 å€‹æ•¸å­—é©—è­‰ç¢¼å®Œæ•´ç…§è‘—è¼¸å…¥åœ¨ä¸‹é¢æ¬„ä½ã€‚
    </p>
    <label>å¡«å¯«ä¿¡ç®±æ”¶åˆ°çš„ 6 å€‹æ•¸å­—é©—è­‰ç¢¼</label>
    <input id="otp" inputmode="numeric" autocomplete="one-time-code" placeholder="ä¾‹å¦‚ï¼š123456" />

    <div class="btnRow">
      <button id="btnBack1" class="secondary">å›ä¸Šä¸€æ­¥</button>
      <button id="btnVerify" class="primary">é©—è­‰ä¸¦æŸ¥è©¢</button>
    </div>

    <div id="msg2" class="msg"></div>
  </section>

  <section id="page3" class="card hidden">
    <h2 id="title3" class="pageTitle">ä¸‹è¼‰å¼±é»åˆ†ææ›¸</h2>

    <div class="pill" id="summary3">å›æ•¸ï¼š2025ç¬¬äºŒå›ã€€ç­‰ç´šï¼šN1ã€€Emailï¼šâ€”</div>

    <div id="msg3" class="msg"></div>

    <div class="btnRow">
      <button id="btnDownload" class="primary hidden">ä¸‹è¼‰å¼±é»åˆ†ææ›¸ï¼ˆé–‹æ–°åˆ†é ï¼‰</button>
      <button id="btnLine" class="secondary">ç§è¨Šå®˜æ–¹ LINE æ‰¾åŠ©æ•™</button>
      <button id="btnHome" class="secondary">å›é¦–é é ˜å…¶ä»–ç­‰ç´š</button>
    </div>
  </section>

</div>

<script type="module">
  const API = {
    request: "https://colanekojp.zeabur.app/webhook/otp/request",
    verify:  "https://colanekojp.zeabur.app/webhook/otp/verify",
    lookup:  "https://colanekojp.zeabur.app/webhook/lookup-link",
  };

  const LINE_URL = "https://page.line.me/ctq6019m?oat_content=url&openQrModal=true";
  const HOME_URL = "https://jlptanalysis.zeabur.app/";

  const state = { round: "2025ç¬¬äºŒå›", level: "N1", email: "", step: 0, downloadingUrl: "" };

  const $ = (id) => document.getElementById(id);
  const pages = [$("page1"), $("page2"), $("page3")];
 
  function normalizeEmail(v){ return String(v || "").trim().toLowerCase(); }
  function normalizeOtp(v){ return String(v || "").trim().replace(/[^0-9]/g, "").slice(0, 6); }

  function setMsg(el, text, ok){
    el.textContent = text;
    el.className = "msg " + (ok ? "ok" : "bad");
  }

  function setLoading(loading){
    [$("btnSend"), $("btnVerify"), $("btnBack1"), $("btnHome"), $("btnLine")].forEach(b => { if (b) b.disabled = loading; });
    $("email").disabled = loading || state.step > 0;
    $("otp").disabled = loading;
    document.querySelectorAll(".lv, .rd").forEach(x => {
      x.style.pointerEvents = (loading || state.step > 0) ? "none" : "auto";
      x.style.opacity = (loading || state.step > 0) ? "0.6" : "1";
    });
  }

  function updateSummaries(){
    const email = state.email ? state.email : "â€”";
    $("summary3").textContent = `å›æ•¸ï¼š${state.round}ã€€ç­‰ç´šï¼š${state.level}ã€€Emailï¼š${email}`;
  }

  function showPage(n){
    state.step = n;
    pages.forEach((p,i) => p.classList.toggle("hidden", i !== n));
    updateSummaries();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  const rounds = ["2025ç¬¬äºŒå›","2025ç¬¬ä¸€å›","2024ç¬¬äºŒå›","2024ç¬¬ä¸€å›","2023ç¬¬äºŒå›","2023ç¬¬ä¸€å›"];
  function renderRounds(){
    const box = $("rounds");
    box.innerHTML = "";
    rounds.forEach(r => {
      const d = document.createElement("div");
      d.className = "rd" + (state.round === r ? " active" : "");
      d.innerHTML = r;
      d.onclick = () => {
        if (state.step > 0) return;
        state.round = r;
        renderRounds();
        updateSummaries();
      };
      box.appendChild(d);
    });
  }

  const levels = ["N1","N2","N3","N4","N5"];
  function renderLevels(){
    const box = $("levels");
    box.innerHTML = "";
    levels.forEach(lv => {
      const d = document.createElement("div");
      d.className = "lv" + (state.level === lv ? " active" : "");
      d.innerHTML = lv;
      d.onclick = () => {
        if (state.step > 0) return;
        state.level = lv;
        renderLevels();
        updateSummaries();
      };
      box.appendChild(d);
    });
  }

  async function post(url, body){
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    return r.json();
  }

  async function handleLookupAndShowResult(){
    // âœ… å…ˆè·³åˆ°çµæœé ï¼ˆçœ‹èµ·ä¾†æ›´åƒå®˜æ–¹æµç¨‹ï¼‰
    showPage(2);

    $("btnLine").onclick = () => window.open(LINE_URL, "_blank", "noopener,noreferrer");
    $("btnHome").onclick = () => location.href = HOME_URL;

    try{
      const l = await post(API.lookup, { round: state.round, level: state.level, email: state.email });

      // é‡ç½®æ¨™é¡Œæ¨£å¼ç‚ºé è¨­ã€Œä¸‹è¼‰å¼±é»åˆ†ææ›¸ã€
      const title3 = $("title3");
      if (title3){
        title3.textContent = "ä¸‹è¼‰å¼±é»åˆ†ææ›¸";
        title3.classList.remove("errorTitle");
      }

      if (!l.ok){
        setLoading(false);

        // å¦‚æœæ˜¯ NOT_FOUNDï¼Œå°±æŠŠå¤§æ¨™æ”¹æˆæç¤ºå¥ï¼Œå­—é«”åŠ å¤§
        if (l.code === "NOT_FOUND" || l.code === "not_found"){
          if (title3){
            title3.textContent = "æŸ¥ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªæ‚¨é¸æ“‡çš„è€ƒè©¦å›æ•¸ã€ç­‰ç´šï¼Œä»¥åŠå¡«å¯«çš„æœƒå“¡ Email æ˜¯å¦èˆ‡ç•¶åˆç™»è¨˜æ™‚ç›¸åŒã€‚";
            title3.classList.add("errorTitle");
          }
          $("msg3").textContent = "";
        } else {
          setMsg($("msg3"), l.message || "ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", false);
        }

        $("btnDownload").classList.add("hidden");

        // è‹¥å¾Œç«¯æœ‰æä¾›æ”¯æ´é€£çµï¼Œå°±ç”¨å¾Œç«¯çš„
        if (l.support && l.support.url){
          $("btnLine").onclick = () => window.open(l.support.url, "_blank", "noopener,noreferrer");
        }
        return;
      }

      const url = (l.data && l.data.url) || l.url || l.link || (l.data && l.data.link);
      if (!url){
        setLoading(false);
        setMsg($("msg3"), "æŸ¥è©¢æˆåŠŸä½†æœªå–å¾—ä¸‹è¼‰é€£çµï¼Œè«‹ç§è¨Šå®˜æ–¹ LINE ç”±åŠ©æ•™å”åŠ©ã€‚", false);
        $("btnDownload").classList.add("hidden");
        return;
      }

      state.downloadingUrl = url;
      setLoading(false);
      setMsg($("msg3"), "âœ… å·²æ‰¾åˆ°ä½ çš„å¼±é»åˆ†ææ›¸ä¸‹è¼‰é€£çµã€‚", true);
      $("btnDownload").classList.remove("hidden");
      $("btnDownload").onclick = () => window.open(state.downloadingUrl, "_blank", "noopener,noreferrer");

    }catch(e){
      setLoading(false);
      setMsg($("msg3"), "ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", false);
      $("btnDownload").classList.add("hidden");
      $("btnLine").onclick = () => window.open(LINE_URL, "_blank", "noopener,noreferrer");
      $("btnHome").onclick = () => location.href = HOME_URL;
    }
  }

  $("btnSend").onclick = async () => {
    const email = normalizeEmail($("email").value);
    if (!email) return setMsg($("msg1"), "è«‹è¼¸å…¥ Email", false);

    state.email = email;
    updateSummaries();

    setLoading(true);
    setMsg($("msg1"), "å¯„é€ä¸­â€¦", true);

    try{
      const res = await post(API.request, { email });
      if (!res.ok){
        setLoading(false);
        return setMsg($("msg1"), res.message || "å¯„é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", false);
      }
      setLoading(false);
      showPage(1);
    }catch(e){
      setLoading(false);
      setMsg($("msg1"), "ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", false);
    }
  };

  $("btnBack1").onclick = () => {
    state.email = "";
    $("email").value = "";
    $("otp").value = "";
    $("msg2").textContent = "";
    showPage(0);
  };

  $("btnVerify").onclick = async () => {
    const otp = normalizeOtp($("otp").value);
    if (otp.length !== 6) return setMsg($("msg2"), "è«‹è¼¸å…¥ 6 ç¢¼é©—è­‰ç¢¼ï¼ˆåªéœ€è¦æ•¸å­—ï¼‰", false);

    setLoading(true);
    setMsg($("msg2"), "é©—è­‰ä¸­â€¦", true);

    try{
      const v = await post(API.verify, { email: state.email, otp });
      if (!v.ok){
        setLoading(false);
        return setMsg($("msg2"), v.message || "é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚", false);
      }

      // é©—è­‰æˆåŠŸå¾Œé€²è¡Œ lookup
      await handleLookupAndShowResult();

    }catch(e){
      setLoading(false);
      showPage(2);
      setMsg($("msg3"), "ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", false);
      $("btnDownload").classList.add("hidden");
      $("btnLine").onclick = () => window.open(LINE_URL, "_blank", "noopener,noreferrer");
      $("btnHome").onclick = () => location.href = HOME_URL;
    }
  };

  renderRounds();
  renderLevels();
  updateSummaries();
  showPage(0);
</script>
</body>
</html>
